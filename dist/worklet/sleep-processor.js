"use strict";(()=>{function M(h){return Math.pow(10,h/20)}function R(h){return h<=0?-1/0:20*Math.log10(h)}function v(h,e,t){return h+(e-h)*t}function y(h,e){let s=Math.max(h/1e3,1e-6)*e;return 1-Math.exp(Math.log(.01)/s)}function g(h,e){return Math.max(1,Math.round(h/1e3*e))}function S(h,e,t){return t<=0?h:e>h?Math.min(h+t,e):Math.max(h-t,e)}var k=class h{constructor(e,t,s,r,a){this.x1=0;this.x2=0;this.y1=0;this.y2=0;this.b0=e,this.b1=t,this.b2=s,this.a1=r,this.a2=a}apply(e){let t=this.b0*e+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;return this.x2=this.x1,this.x1=e,this.y2=this.y1,this.y1=t,t}reset(){this.x1=0,this.x2=0,this.y1=0,this.y2=0}static kWeightHighShelf(e){let t=3.9998439,s=.70717525,a=Math.tan(Math.PI*1681.9745/e),o=Math.pow(10,t/20),i=Math.pow(o,.49966678),n=1+a/s+a*a;return new h((o+i*a/s+a*a)/n,2*(a*a-o)/n,(o-i*a/s+a*a)/n,2*(a*a-1)/n,(1-a/s+a*a)/n)}static kWeightHighPass(e){let t=.50032705,r=Math.tan(Math.PI*38.13547/e),a=1+r/t+r*r;return new h(1,-2,1,2*(r*r-1)/a,(1-r/t+r*r)/a)}},w=class{constructor(e){this.stage1=k.kWeightHighShelf(e),this.stage2=k.kWeightHighPass(e)}apply(e){return this.stage2.apply(this.stage1.apply(e))}reset(){this.stage1.reset(),this.stage2.reset()}},F=class{constructor(e,t){this.energyIndex=0;this.energyFilled=0;this.energySum=0;this.framesSinceUpdate=0;this.framesSinceRecalc=0;this.gainDb=0;this.gainLin=1;this.params=t,this.sampleRate=e,this.windowFrames=g(t.windowMs,e),this.updateIntervalFrames=g(t.updateIntervalMs,e),this.kL=new w(e),this.kR=new w(e),this.energyBuf=new Float64Array(this.windowFrames),this.currentLufs=t.targetLufs}setParams(e){let t=g(e.windowMs,this.sampleRate),s=g(e.updateIntervalMs,this.sampleRate);(t!==this.windowFrames||s!==this.updateIntervalFrames)&&(this.windowFrames=t,this.updateIntervalFrames=s,this.energyBuf=new Float64Array(t),this.energyIndex=0,this.energyFilled=0,this.energySum=0,this.framesSinceUpdate=0,this.kL=new w(this.sampleRate),this.kR=new w(this.sampleRate)),this.params=e}processFrame(e,t){let s=this.kL.apply(e),r=this.kR.apply(t),a=(s*s+r*r)*.5,o=this.energyBuf[this.energyIndex];if(this.energyBuf[this.energyIndex]=a,this.energySum+=a-o,this.energyIndex++,this.energyIndex>=this.windowFrames&&(this.energyIndex=0),this.energyFilled<this.windowFrames&&this.energyFilled++,this.framesSinceRecalc++,this.framesSinceRecalc>=this.windowFrames){this.framesSinceRecalc=0;let i=0;for(let n=0;n<this.energyFilled;n++)i+=this.energyBuf[n];this.energySum=i}return this.framesSinceUpdate++,this.framesSinceUpdate>=this.updateIntervalFrames&&(this.framesSinceUpdate=0,this.updateGain()),[e*this.gainLin,t*this.gainLin]}updateGain(){let e=Math.max(1,this.energyFilled),t=Math.max(this.energySum/e,1e-12);this.currentLufs=-.691+10*Math.log10(t);let s=this.params.targetLufs-this.currentLufs;this.currentLufs<this.params.gateLufs&&s>this.gainDb&&(s=this.gainDb);let r=Math.max(this.params.maxGainDb,0),a=this.currentLufs<this.params.boostBelowLufs?r:0;s=Math.min(a,s);let o=this.updateIntervalFrames/this.sampleRate,i=Math.max(this.params.maxGainChangeDbPerS,0)*o;this.gainDb=S(this.gainDb,s,i),this.gainLin=M(this.gainDb)}},x=class{constructor(e,t){this.powerIndex=0;this.powerFilled=0;this.powerSum=0;this.framesSinceRecalc=0;this.gainDb=0;this.currentGain=1;this.params=t,this.sampleRate=e,this.windowFrames=g(t.windowMs,e),this.powerBuf=new Float64Array(this.windowFrames)}setParams(e){let t=g(e.windowMs,this.sampleRate);t!==this.windowFrames&&(this.windowFrames=t,this.powerBuf=new Float64Array(t),this.powerIndex=0,this.powerFilled=0,this.powerSum=0),this.params=e}processFrame(e,t){let s=(e*e+t*t)*.5,r=this.powerBuf[this.powerIndex];if(this.powerBuf[this.powerIndex]=s,this.powerSum+=s-r,this.powerIndex++,this.powerIndex>=this.windowFrames&&(this.powerIndex=0),this.powerFilled<this.windowFrames&&this.powerFilled++,this.framesSinceRecalc++,this.framesSinceRecalc>=this.windowFrames){this.framesSinceRecalc=0;let b=0;for(let c=0;c<this.powerFilled;c++)b+=this.powerBuf[c];this.powerSum=b}let a=Math.max(1,this.powerFilled),o=Math.max(this.powerSum/a,1e-12),n=10*Math.log10(o)-this.params.thresholdDb,l=this.params.kneeDb*.5,p=1-1/this.params.ratio,m;if(n<=-l)m=0;else if(n>=l)m=-(n*p);else{let b=n+l;m=-(b*b/(2*this.params.kneeDb))*p}let u=y(this.params.attackMs,this.sampleRate),d=y(this.params.releaseMs,this.sampleRate);return m<this.gainDb?this.gainDb=v(this.gainDb,m,u):this.gainDb=v(this.gainDb,m,d),this.currentGain=M(this.gainDb),[e*this.currentGain,t*this.currentGain]}gainReductionDb(){return isFinite(this.gainDb)?-this.gainDb:0}},P=class{constructor(e,t){this.delayIndex=0;this.peakEnvelope=0;this.currentGain=1;this.params=t,this.sampleRate=e,this.lookaheadFrames=Math.max(1,Math.round(t.lookaheadMs/1e3*e)),this.delayBuf=new Float32Array(this.lookaheadFrames*2)}setParams(e){let t=Math.max(1,Math.round(e.lookaheadMs/1e3*this.sampleRate));t!==this.lookaheadFrames&&(this.lookaheadFrames=t,this.delayBuf=new Float32Array(t*2),this.delayIndex=0,this.peakEnvelope=0,this.currentGain=1),this.params=e}processFrame(e,t){let s=M(this.params.thresholdDb),r=y(this.params.attackMs,this.sampleRate),a=y(this.params.releaseMs,this.sampleRate),o=Math.exp(-1/(Math.max(this.params.releaseMs/1e3,1e-6)*this.sampleRate)),i=Math.max(Math.abs(e),Math.abs(t));this.peakEnvelope=Math.max(this.peakEnvelope*o,i);let n=this.peakEnvelope>s?Math.min(s/this.peakEnvelope,1):1;n<this.currentGain?this.currentGain=v(this.currentGain,n,r):this.currentGain=v(this.currentGain,n,a);let l=this.delayIndex*2,p=this.delayBuf[l]*this.currentGain,m=this.delayBuf[l+1]*this.currentGain,u=Math.max(Math.abs(p),Math.abs(m));if(u>s){let d=s/u;p*=d,m*=d}return this.delayBuf[l]=e,this.delayBuf[l+1]=t,this.delayIndex++,this.delayIndex>=this.lookaheadFrames&&(this.delayIndex=0),[p,m]}gainReductionDb(){let e=R(Math.max(this.currentGain,1e-12));return isFinite(e)?-e:0}},L=4,I=class{constructor(e,t){this.delayIndex=0;this.histIndex=0;this.peakEnvelope=0;this.currentGain=1;this.params=t,this.sampleRate=e,this.ceilingLin=M(t.ceilingDbTp),this.lookaheadFrames=Math.max(1,Math.round(t.lookaheadMs/1e3*e)),this.delayBuf=new Float32Array(this.lookaheadFrames*2),this.histL=new Float32Array(4),this.histR=new Float32Array(4)}setParams(e){this.params=e,this.ceilingLin=M(e.ceilingDbTp);let t=Math.max(1,Math.round(e.lookaheadMs/1e3*this.sampleRate));t!==this.lookaheadFrames&&(this.lookaheadFrames=t,this.delayBuf=new Float32Array(t*2),this.delayIndex=0)}estimateTruePeak(e,t){let s=this.histIndex;this.histL[s]=e,this.histR[s]=t,this.histIndex=s+1&3;let r=Math.max(Math.abs(e),Math.abs(t)),a=s+3&3,o=this.histL[a],i=this.histR[a];for(let n=1;n<L;n++){let l=n/L,p=o+(e-o)*l,m=i+(t-i)*l,u=Math.max(Math.abs(p),Math.abs(m));u>r&&(r=u)}return r}processFrame(e,t){let s=this.ceilingLin,r=y(this.params.releaseMs,this.sampleRate),a=this.estimateTruePeak(e,t);a>this.peakEnvelope?this.peakEnvelope=a:this.peakEnvelope=v(this.peakEnvelope,a,r);let o=this.peakEnvelope>s?Math.min(s/this.peakEnvelope,1):1;o<this.currentGain?this.currentGain=o:this.currentGain=v(this.currentGain,o,r);let i=this.delayIndex*2,n=this.delayBuf[i]*this.currentGain,l=this.delayBuf[i+1]*this.currentGain,p=Math.max(Math.abs(n),Math.abs(l));if(p>s){let m=s/p;n*=m,l*=m}return this.delayBuf[i]=e,this.delayBuf[i+1]=t,this.delayIndex++,this.delayIndex>=this.lookaheadFrames&&(this.delayIndex=0),[n,l]}gainReductionDb(){let e=R(Math.max(this.currentGain,1e-12));return isFinite(e)?-e:0}},D=class extends AudioWorkletProcessor{constructor(t){super();this.meteringCounter=0;this.bypassed=!1;let s=t?.processorOptions||{},r=s.sampleRate||48e3,a=s.params||{normalizer:{targetLufs:-16,windowMs:3e3,updateIntervalMs:100,maxGainDb:3,maxGainChangeDbPerS:1,gateLufs:-60,boostBelowLufs:-35},compressor:{thresholdDb:-24,ratio:6,attackMs:15,releaseMs:400,windowMs:100,kneeDb:6},limiter:{thresholdDb:-3,lookaheadMs:5,attackMs:1,releaseMs:50},truePeak:{ceilingDbTp:-1,lookaheadMs:1.5,releaseMs:50}};this.normalizer=new F(r,a.normalizer),this.compressor=new x(r,a.compressor),this.limiter=new P(r,a.limiter),this.truePeak=new I(r,a.truePeak),this.meteringInterval=Math.round(r/10),this.port.onmessage=o=>{let i=o.data;i.type==="SET_PARAMS"?(this.normalizer.setParams(i.params.normalizer),this.compressor.setParams(i.params.compressor),this.limiter.setParams(i.params.limiter),this.truePeak.setParams(i.params.truePeak)):i.type==="SET_BYPASS"&&(this.bypassed=i.bypassed)}}process(t,s){let r=t[0],a=s[0];if(!r||!r[0])return!0;if(this.bypassed){for(let u=0;u<a.length;u++){let d=r[u]||r[0];a[u].set(d)}return!0}let o=r[0],i=r[1]||r[0],n=a[0],l=a[1]||a[0],p=o.length,m=0;for(let u=0;u<p;u++){let d=Math.abs(o[u]),b=Math.abs(i[u]);d>m&&(m=d),b>m&&(m=b);let[c,f]=this.normalizer.processFrame(o[u],i[u]);[c,f]=this.compressor.processFrame(c,f),[c,f]=this.limiter.processFrame(c,f),[c,f]=this.truePeak.processFrame(c,f),n[u]=c,l!==n&&(l[u]=f)}return this.meteringCounter+=p,this.meteringCounter>=this.meteringInterval&&(this.meteringCounter=0,this.port.postMessage({type:"METERING",lufs:this.normalizer.currentLufs,gainReductionDb:this.compressor.gainReductionDb()+this.limiter.gainReductionDb()+this.truePeak.gainReductionDb(),inputPeakDb:m>0?20*Math.log10(m):-1/0})),!0}};registerProcessor("sleep-processor",D);})();
