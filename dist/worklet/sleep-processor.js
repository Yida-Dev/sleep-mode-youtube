"use strict";(()=>{function w(o){return Math.pow(10,o/20)}function L(o){return o<=0?-1/0:20*Math.log10(o)}function f(o,e,t){return o+(e-o)*t}function v(o,e){let s=Math.max(o/1e3,1e-6)*e;return 1-Math.exp(Math.log(.01)/s)}function d(o,e){return Math.max(1,Math.round(o/1e3*e))}function R(o,e,t){return t<=0?o:e>o?Math.min(o+t,e):Math.max(o-t,e)}var M=class o{constructor(e,t,s,r,a){this.x1=0;this.x2=0;this.y1=0;this.y2=0;this.b0=e,this.b1=t,this.b2=s,this.a1=r,this.a2=a}apply(e){let t=this.b0*e+this.b1*this.x1+this.b2*this.x2-this.a1*this.y1-this.a2*this.y2;return this.x2=this.x1,this.x1=e,this.y2=this.y1,this.y1=t,t}reset(){this.x1=0,this.x2=0,this.y1=0,this.y2=0}static kWeightHighShelf(e){let t=3.9998439,s=.70717525,a=Math.tan(Math.PI*1681.9745/e),m=Math.pow(10,t/20),n=Math.pow(m,.49966678),i=1+a/s+a*a;return new o((m+n*a/s+a*a)/i,2*(a*a-m)/i,(m-n*a/s+a*a)/i,2*(a*a-1)/i,(1-a/s+a*a)/i)}static kWeightHighPass(e){let t=.50032705,r=Math.tan(Math.PI*38.13547/e),a=1+r/t+r*r;return new o(1,-2,1,2*(r*r-1)/a,(1-r/t+r*r)/a)}},b=class{constructor(e){this.stage1=M.kWeightHighShelf(e),this.stage2=M.kWeightHighPass(e)}apply(e){return this.stage2.apply(this.stage1.apply(e))}reset(){this.stage1.reset(),this.stage2.reset()}},k=class{constructor(e,t){this.energyIndex=0;this.energyFilled=0;this.energySum=0;this.framesSinceUpdate=0;this.framesSinceRecalc=0;this.gainDb=0;this.gainLin=1;this.params=t,this.sampleRate=e,this.windowFrames=d(t.windowMs,e),this.updateIntervalFrames=d(t.updateIntervalMs,e),this.kL=new b(e),this.kR=new b(e),this.energyBuf=new Float64Array(this.windowFrames),this.currentLufs=t.targetLufs}setParams(e){let t=d(e.windowMs,this.sampleRate),s=d(e.updateIntervalMs,this.sampleRate);(t!==this.windowFrames||s!==this.updateIntervalFrames)&&(this.windowFrames=t,this.updateIntervalFrames=s,this.energyBuf=new Float64Array(t),this.energyIndex=0,this.energyFilled=0,this.energySum=0,this.framesSinceUpdate=0,this.kL=new b(this.sampleRate),this.kR=new b(this.sampleRate)),this.params=e}processFrame(e,t){let s=this.kL.apply(e),r=this.kR.apply(t),a=(s*s+r*r)*.5,m=this.energyBuf[this.energyIndex];if(this.energyBuf[this.energyIndex]=a,this.energySum+=a-m,this.energyIndex++,this.energyIndex>=this.windowFrames&&(this.energyIndex=0),this.energyFilled<this.windowFrames&&this.energyFilled++,this.framesSinceRecalc++,this.framesSinceRecalc>=this.windowFrames){this.framesSinceRecalc=0;let n=0;for(let i=0;i<this.energyFilled;i++)n+=this.energyBuf[i];this.energySum=n}return this.framesSinceUpdate++,this.framesSinceUpdate>=this.updateIntervalFrames&&(this.framesSinceUpdate=0,this.updateGain()),[e*this.gainLin,t*this.gainLin]}updateGain(){let e=Math.max(1,this.energyFilled),t=Math.max(this.energySum/e,1e-12);this.currentLufs=-.691+10*Math.log10(t);let s=this.params.targetLufs-this.currentLufs;this.currentLufs<this.params.gateLufs&&s>this.gainDb&&(s=this.gainDb);let r=Math.max(this.params.maxGainDb,0),a=this.currentLufs<this.params.boostBelowLufs?r:0;s=Math.min(a,s);let m=this.updateIntervalFrames/this.sampleRate,n=Math.max(this.params.maxGainChangeDbPerS,0)*m;this.gainDb=R(this.gainDb,s,n),this.gainLin=w(this.gainDb)}},F=class{constructor(e,t){this.powerIndex=0;this.powerFilled=0;this.powerSum=0;this.framesSinceRecalc=0;this.gainDb=0;this.currentGain=1;this.params=t,this.sampleRate=e,this.windowFrames=d(t.windowMs,e),this.powerBuf=new Float64Array(this.windowFrames)}setParams(e){let t=d(e.windowMs,this.sampleRate);t!==this.windowFrames&&(this.windowFrames=t,this.powerBuf=new Float64Array(t),this.powerIndex=0,this.powerFilled=0,this.powerSum=0),this.params=e}processFrame(e,t){let s=(e*e+t*t)*.5,r=this.powerBuf[this.powerIndex];if(this.powerBuf[this.powerIndex]=s,this.powerSum+=s-r,this.powerIndex++,this.powerIndex>=this.windowFrames&&(this.powerIndex=0),this.powerFilled<this.windowFrames&&this.powerFilled++,this.framesSinceRecalc++,this.framesSinceRecalc>=this.windowFrames){this.framesSinceRecalc=0;let g=0;for(let y=0;y<this.powerFilled;y++)g+=this.powerBuf[y];this.powerSum=g}let a=Math.max(1,this.powerFilled),m=Math.max(this.powerSum/a,1e-12),i=10*Math.log10(m)-this.params.thresholdDb,u=this.params.kneeDb*.5,p=1-1/this.params.ratio,h;if(i<=-u)h=0;else if(i>=u)h=-(i*p);else{let g=i+u;h=-(g*g/(2*this.params.kneeDb))*p}let l=v(this.params.attackMs,this.sampleRate),c=v(this.params.releaseMs,this.sampleRate);return h<this.gainDb?this.gainDb=f(this.gainDb,h,l):this.gainDb=f(this.gainDb,h,c),this.currentGain=w(this.gainDb),[e*this.currentGain,t*this.currentGain]}gainReductionDb(){return isFinite(this.gainDb)?-this.gainDb:0}},x=class{constructor(e,t){this.delayIndex=0;this.peakEnvelope=0;this.currentGain=1;this.params=t,this.sampleRate=e,this.lookaheadFrames=Math.max(1,Math.round(t.lookaheadMs/1e3*e)),this.delayBuf=new Float32Array(this.lookaheadFrames*2)}setParams(e){let t=Math.max(1,Math.round(e.lookaheadMs/1e3*this.sampleRate));t!==this.lookaheadFrames&&(this.lookaheadFrames=t,this.delayBuf=new Float32Array(t*2),this.delayIndex=0,this.peakEnvelope=0,this.currentGain=1),this.params=e}processFrame(e,t){let s=w(this.params.thresholdDb),r=v(this.params.attackMs,this.sampleRate),a=v(this.params.releaseMs,this.sampleRate),m=Math.exp(-1/(Math.max(this.params.releaseMs/1e3,1e-6)*this.sampleRate)),n=Math.max(Math.abs(e),Math.abs(t));this.peakEnvelope=Math.max(this.peakEnvelope*m,n);let i=this.peakEnvelope>s?Math.min(s/this.peakEnvelope,1):1;i<this.currentGain?this.currentGain=f(this.currentGain,i,r):this.currentGain=f(this.currentGain,i,a);let u=this.delayIndex*2,p=this.delayBuf[u]*this.currentGain,h=this.delayBuf[u+1]*this.currentGain,l=Math.max(Math.abs(p),Math.abs(h));if(l>s){let c=s/l;p*=c,h*=c}return this.delayBuf[u]=e,this.delayBuf[u+1]=t,this.delayIndex++,this.delayIndex>=this.lookaheadFrames&&(this.delayIndex=0),[p,h]}gainReductionDb(){let e=L(Math.max(this.currentGain,1e-12));return isFinite(e)?-e:0}},I=4,P=class{constructor(e,t){this.delayIndex=0;this.histIndex=0;this.peakEnvelope=0;this.currentGain=1;this.params=t,this.sampleRate=e,this.ceilingLin=w(t.ceilingDbTp),this.lookaheadFrames=Math.max(1,Math.round(t.lookaheadMs/1e3*e)),this.delayBuf=new Float32Array(this.lookaheadFrames*2),this.histL=new Float32Array(4),this.histR=new Float32Array(4)}setParams(e){this.params=e,this.ceilingLin=w(e.ceilingDbTp);let t=Math.max(1,Math.round(e.lookaheadMs/1e3*this.sampleRate));t!==this.lookaheadFrames&&(this.lookaheadFrames=t,this.delayBuf=new Float32Array(t*2),this.delayIndex=0)}estimateTruePeak(e,t){let s=this.histIndex;this.histL[s]=e,this.histR[s]=t,this.histIndex=s+1&3;let r=Math.max(Math.abs(e),Math.abs(t)),a=s+3&3,m=this.histL[a],n=this.histR[a];for(let i=1;i<I;i++){let u=i/I,p=m+(e-m)*u,h=n+(t-n)*u,l=Math.max(Math.abs(p),Math.abs(h));l>r&&(r=l)}return r}processFrame(e,t){let s=this.ceilingLin,r=v(this.params.releaseMs,this.sampleRate),a=this.estimateTruePeak(e,t);a>this.peakEnvelope?this.peakEnvelope=a:this.peakEnvelope=f(this.peakEnvelope,a,r);let m=this.peakEnvelope>s?Math.min(s/this.peakEnvelope,1):1;m<this.currentGain?this.currentGain=m:this.currentGain=f(this.currentGain,m,r);let n=this.delayIndex*2,i=this.delayBuf[n]*this.currentGain,u=this.delayBuf[n+1]*this.currentGain,p=Math.max(Math.abs(i),Math.abs(u));if(p>s){let h=s/p;i*=h,u*=h}return this.delayBuf[n]=e,this.delayBuf[n+1]=t,this.delayIndex++,this.delayIndex>=this.lookaheadFrames&&(this.delayIndex=0),[i,u]}gainReductionDb(){let e=L(Math.max(this.currentGain,1e-12));return isFinite(e)?-e:0}},D=class extends AudioWorkletProcessor{constructor(t){super();this.meteringCounter=0;this.bypassed=!1;let s=t?.processorOptions||{},r=s.sampleRate||48e3,a=s.params||{normalizer:{targetLufs:-16,windowMs:3e3,updateIntervalMs:100,maxGainDb:3,maxGainChangeDbPerS:1,gateLufs:-60,boostBelowLufs:-35},compressor:{thresholdDb:-24,ratio:6,attackMs:15,releaseMs:400,windowMs:100,kneeDb:6},limiter:{thresholdDb:-3,lookaheadMs:5,attackMs:1,releaseMs:50},truePeak:{ceilingDbTp:-1,lookaheadMs:1.5,releaseMs:50}};this.normalizer=new k(r,a.normalizer),this.compressor=new F(r,a.compressor),this.limiter=new x(r,a.limiter),this.truePeak=new P(r,a.truePeak),this.meteringInterval=Math.round(r/10),this.port.onmessage=m=>{let n=m.data;n.type==="SET_PARAMS"?(this.normalizer.setParams(n.params.normalizer),this.compressor.setParams(n.params.compressor),this.limiter.setParams(n.params.limiter),this.truePeak.setParams(n.params.truePeak)):n.type==="SET_BYPASS"&&(this.bypassed=n.bypassed)}}process(t,s){let r=t[0],a=s[0];if(!r||!r[0])return!0;if(this.bypassed){for(let h=0;h<a.length;h++){let l=r[h]||r[0];a[h].set(l)}return!0}let m=r[0],n=r[1]||r[0],i=a[0],u=a[1]||a[0],p=m.length;for(let h=0;h<p;h++){let[l,c]=this.normalizer.processFrame(m[h],n[h]);[l,c]=this.compressor.processFrame(l,c),[l,c]=this.limiter.processFrame(l,c),[l,c]=this.truePeak.processFrame(l,c),i[h]=l,u!==i&&(u[h]=c)}return this.meteringCounter+=p,this.meteringCounter>=this.meteringInterval&&(this.meteringCounter=0,this.port.postMessage({type:"METERING",lufs:this.normalizer.currentLufs,gainReductionDb:this.compressor.gainReductionDb()+this.limiter.gainReductionDb()+this.truePeak.gainReductionDb()})),!0}};registerProcessor("sleep-processor",D);})();
