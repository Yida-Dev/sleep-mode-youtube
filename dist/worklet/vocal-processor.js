"use strict";(()=>{function D(o,a){let i=0;for(let t=0;t<a;t++)i=i<<1|o&1,o>>=1;return i}function R(o,a,i){let t=Math.log2(a)|0;for(let n=0;n<a;n++){let c=D(n,t);if(n<c){let u=n<<1,h=c<<1,l=o[u],e=o[u+1];o[u]=o[h],o[u+1]=o[h+1],o[h]=l,o[h+1]=e}}let s=i?1:-1,r=2;for(;r<=a;){let n=r>>1,c=s*2*Math.PI/r,u=Math.cos(c),h=Math.sin(c);for(let l=0;l<a;l+=r){let e=1,p=0;for(let d=0;d<n;d++){let P=l+d<<1,m=l+d+n<<1,v=o[P],g=o[P+1],B=e*o[m]-p*o[m+1],w=e*o[m+1]+p*o[m];o[P]=v+B,o[P+1]=g+w,o[m]=v-B,o[m+1]=g-w;let M=e*u-p*h;p=e*h+p*u,e=M}}r<<=1}if(i){let n=1/a,c=a<<1;for(let u=0;u<c;u++)o[u]*=n}}var f=2048,b=f>>1;function A(o){return Math.pow(10,o/20)}var F=class{constructor(a,i){this.inputCount=0;this.outputReadPos=0;this.sideDelayPos=0;this.crossfadePos=0;this.isFadingIn=!1;this.isFadingOut=!1;this.sampleRate=a,this.params=i,this.window=new Float32Array(f);for(let s=0;s<f;s++)this.window[s]=.5*(1-Math.cos(2*Math.PI*s/f));let t=(f>>1)+1;this.binGains=new Float32Array(t),this.inputBuf=new Float32Array(f),this.outputBuf=new Float32Array(f+b),this.fftBuf=new Float32Array(f*2),this.sideDelay=new Float32Array(f),this.crossfadeLen=Math.floor(a*.01),this.updateBinGains()}setParams(a){let i=this.params.enabled,t=Math.abs(this.params.vocalGainDb-a.vocalGainDb)>1e-6||Math.abs(this.params.musicReductionDb-a.musicReductionDb)>1e-6;this.params=a,t&&this.updateBinGains(),!i&&a.enabled?(this.isFadingIn=!0,this.isFadingOut=!1,this.crossfadePos=0):i&&!a.enabled&&(this.isFadingOut=!0,this.isFadingIn=!1,this.crossfadePos=0)}processFrame(a,i){if(!this.params.enabled&&!this.isFadingOut)return[a,i];let t=(a+i)*.5,s=(a-i)*.5,r=this.sideDelay[this.sideDelayPos];this.sideDelay[this.sideDelayPos]=s,this.sideDelayPos=(this.sideDelayPos+1)%this.sideDelay.length,this.inputBuf[this.inputCount]=t,this.inputCount++,this.inputCount>=f&&(this.processFftFrame(),this.inputBuf.copyWithin(0,b,f),this.inputCount=b);let n=this.outputBuf[this.outputReadPos];this.outputBuf[this.outputReadPos]=0,this.outputReadPos=(this.outputReadPos+1)%this.outputBuf.length;let c=n+r,u=n-r,h,l;if(this.isFadingIn){let e=this.crossfadePos/this.crossfadeLen,p=Math.min(e,1);this.crossfadePos++,this.crossfadePos>=this.crossfadeLen&&(this.isFadingIn=!1),h=a+(c-a)*p,l=i+(u-i)*p}else if(this.isFadingOut){let e=this.crossfadePos/this.crossfadeLen,p=Math.max(1-e,0);this.crossfadePos++,this.crossfadePos>=this.crossfadeLen&&(this.isFadingOut=!1),h=a+(c-a)*p,l=i+(u-i)*p}else h=c,l=u;return[h,l]}processFftFrame(){for(let t=0;t<f;t++){let s=t<<1;this.fftBuf[s]=this.inputBuf[t]*this.window[t],this.fftBuf[s+1]=0}R(this.fftBuf,f,!1);let a=(f>>1)+1;for(let t=0;t<a;t++){let s=this.binGains[t],r=t<<1;if(this.fftBuf[r]*=s,this.fftBuf[r+1]*=s,t>0&&t<f>>1){let n=f-t<<1;this.fftBuf[n]*=s,this.fftBuf[n+1]*=s}}R(this.fftBuf,f,!0);let i=this.outputBuf.length;for(let t=0;t<f;t++){let s=(this.outputReadPos+t)%i;this.outputBuf[s]+=this.fftBuf[t<<1]}}updateBinGains(){let a=(f>>1)+1,i=A(this.params.vocalGainDb),t=A(this.params.musicReductionDb),s=80,r=300,n=3400,c=8e3,u=this.sampleRate/f;for(let h=0;h<a;h++){let l=h*u,e;if(l<s)e=0;else if(l<r){let p=(l-s)/(r-s);e=.5-.5*Math.cos(Math.PI*p)}else if(l<=n)e=1;else if(l<c){let p=(l-n)/(c-n);e=.5+.5*Math.cos(Math.PI*p)}else e=0;this.binGains[h]=e*i+(1-e)*t}}},y=class extends AudioWorkletProcessor{constructor(i){super();this.bypassed=!1;let t=i?.processorOptions||{},s=t.sampleRate||48e3,r=t.params||{separator:{enabled:!1,vocalGainDb:0,musicReductionDb:-12}};this.separator=new F(s,r.separator),this.port.onmessage=n=>{let c=n.data;c.type==="SET_PARAMS"?this.separator.setParams(c.params.separator):c.type==="SET_BYPASS"&&(this.bypassed=c.bypassed)}}process(i,t){let s=i[0],r=t[0];if(!s||!s[0])return!0;if(this.bypassed){for(let e=0;e<r.length;e++){let p=s[e]||s[0];r[e].set(p)}return!0}let n=s[0],c=s[1]||s[0],u=r[0],h=r[1]||r[0],l=n.length;for(let e=0;e<l;e++){let[p,d]=this.separator.processFrame(n[e],c[e]);u[e]=p,h!==u&&(h[e]=d)}return!0}};registerProcessor("vocal-processor",y);})();
