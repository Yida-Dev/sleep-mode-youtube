"use strict";(()=>{var v=class{constructor(t){this.observer=null;this.currentVideo=null;this.handleNavigate=()=>{this.callbacks.onNavigate(),this.findVideo()};this.handleMutation=()=>{(!this.currentVideo||!document.contains(this.currentVideo))&&this.findVideo()};this.callbacks=t}start(){document.addEventListener("yt-navigate-finish",this.handleNavigate),this.observer=new MutationObserver(this.handleMutation),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.findVideo()}stop(){document.removeEventListener("yt-navigate-finish",this.handleNavigate),this.observer&&(this.observer.disconnect(),this.observer=null),this.currentVideo=null}findVideo(){let t=document.querySelectorAll("video.html5-main-video, video.video-stream"),a=Array.from(t).find(n=>n.src)??t[0]??null;a&&a!==this.currentVideo&&(this.currentVideo=a,this.callbacks.onVideoFound(a))}};var k={targetLufs:-16,windowMs:3e3,updateIntervalMs:100,maxGainDb:3,maxGainChangeDbPerS:1,gateLufs:-60,boostBelowLufs:-35},T={thresholdDb:-24,ratio:6,attackMs:15,releaseMs:400,windowMs:100,kneeDb:6},D={thresholdDb:-3,lookaheadMs:5,attackMs:1,releaseMs:50},M={ceilingDbTp:-2,lookaheadMs:1.5,releaseMs:50},A={highPassHz:80,lowShelfHz:200,lowShelfGainDb:0,peakingHz:3e3,peakingGainDb:0,peakingQ:.7,highShelfHz:6e3,highShelfGainDb:-4},Z={highPassHz:0,lowShelfHz:150,lowShelfGainDb:0,peakingHz:4e3,peakingGainDb:0,peakingQ:.8,highShelfHz:1e4,highShelfGainDb:0},J={highPassHz:80,lowShelfHz:300,lowShelfGainDb:-3,peakingHz:3e3,peakingGainDb:0,peakingQ:.8,highShelfHz:7e3,highShelfGainDb:0},X={highPassHz:80,lowShelfHz:150,lowShelfGainDb:0,peakingHz:3e3,peakingGainDb:0,peakingQ:.7,highShelfHz:4e3,highShelfGainDb:0},V={separator:{enabled:!1,vocalGainDb:0,musicReductionDb:-12}},ee=[{id:"sleep",name:"Sleep",description:"Warm tone, gentle dynamics, optimized for falling asleep",playbackRate:.94,params:{worklet:{normalizer:{...k,targetLufs:-26},compressor:{...T},limiter:{...D},truePeak:{...M}},eq:{...A},eqEnabled:!0,masterGainDb:-6,vocal:{separator:{enabled:!0,vocalGainDb:0,musicReductionDb:-6}}}},{id:"asmr",name:"ASMR",description:"Preserve sub-harmonics, enhance whisper texture",playbackRate:1,params:{worklet:{normalizer:{...k,targetLufs:-28},compressor:{...T,thresholdDb:-26},limiter:{...D,thresholdDb:-6},truePeak:{...M}},eq:{...Z},eqEnabled:!0,masterGainDb:-6,vocal:{...V}}},{id:"podcast",name:"Podcast",description:"Vocal clarity, reduced mud, enhanced presence",playbackRate:.94,params:{worklet:{normalizer:{...k,targetLufs:-24},compressor:{...T,thresholdDb:-20,ratio:3,attackMs:20,releaseMs:300,kneeDb:8},limiter:{...D},truePeak:{...M,ceilingDbTp:-1}},eq:{...J},eqEnabled:!0,masterGainDb:-3,vocal:{separator:{enabled:!0,vocalGainDb:3,musicReductionDb:-6}}}},{id:"whitenoise",name:"White Noise",description:"Lower target loudness, minimal processing",playbackRate:1,params:{worklet:{normalizer:{...k,targetLufs:-26},compressor:{...T,thresholdDb:-22,ratio:3,attackMs:20,releaseMs:300},limiter:{...D,thresholdDb:-6},truePeak:{...M}},eq:{...X},eqEnabled:!1,masterGainDb:-3,vocal:{...V}}}];function E(e){return ee.find(t=>t.id===e)}var H=48e3,L="sleep";function x(e){return Math.pow(10,e/20)}async function F(e,t){try{let a=chrome.runtime.getURL(`dist/worklet/${t}`);await e.audioWorklet.addModule(a)}catch(a){console.warn(`[Sleep Mode] Direct worklet load failed for ${t}, trying blob fallback:`,a);try{let o=await(await fetch(chrome.runtime.getURL(`dist/worklet/${t}`))).text(),i=new Blob([o],{type:"text/javascript"}),l=URL.createObjectURL(i);await e.audioWorklet.addModule(l),URL.revokeObjectURL(l)}catch(n){throw console.error(`[Sleep Mode] Failed to load worklet ${t} (both methods failed):`,n),n}}}async function W(e,t){let a=new AudioContext({sampleRate:H});await F(a,"sleep-processor.js"),await F(a,"vocal-processor.js");let n=a.createMediaElementSource(e),o=new AudioWorkletNode(a,"vocal-processor",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[2],processorOptions:{sampleRate:a.sampleRate,params:t.vocal}}),i=new AudioWorkletNode(a,"sleep-processor",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[2],processorOptions:{sampleRate:a.sampleRate,params:t.worklet}}),l=a.createBiquadFilter();l.type="highpass";let p=a.createBiquadFilter();p.type="lowshelf";let u=a.createBiquadFilter();u.type="peaking";let m=a.createBiquadFilter();m.type="highshelf",O(l,p,u,m,t.eq,t.eqEnabled);let c=a.createGain();c.gain.value=x(t.masterGainDb),n.connect(o),o.connect(l),l.connect(p),p.connect(u),u.connect(m),m.connect(i),i.connect(c),c.connect(a.destination);let G=null,y=!1,_=x(t.masterGainDb);return i.port.onmessage=s=>{s.data.type==="METERING"&&G&&G({currentLufs:s.data.lufs,gainReductionDb:s.data.gainReductionDb,inputPeakDb:s.data.inputPeakDb,timestamp:Date.now()})},{ctx:a,source:n,workletNode:i,vocalNode:o,hpf:l,eqLow:p,eqMid:u,eqHigh:m,gain:c,destroy(){n.disconnect(),o.disconnect(),l.disconnect(),i.disconnect(),p.disconnect(),u.disconnect(),m.disconnect(),c.disconnect(),a.close().catch(()=>{})},bypass(){y||(y=!0,i.port.postMessage({type:"SET_BYPASS",bypassed:!0}),o.port.postMessage({type:"SET_BYPASS",bypassed:!0}),n.disconnect(),o.disconnect(),l.disconnect(),i.disconnect(),p.disconnect(),u.disconnect(),m.disconnect(),c.disconnect(),n.connect(a.destination))},engage(){y&&(y=!1,n.disconnect(),n.connect(o),o.connect(l),l.connect(p),p.connect(u),u.connect(m),m.connect(i),i.connect(c),c.connect(a.destination),i.port.postMessage({type:"SET_BYPASS",bypassed:!1}),o.port.postMessage({type:"SET_BYPASS",bypassed:!1}),c.gain.setValueAtTime(0,a.currentTime),c.gain.linearRampToValueAtTime(_,a.currentTime+.02))},setPreset(s){this.setWorkletParams(s.worklet),this.setEqParams(s.eq,s.eqEnabled),this.setMasterGain(s.masterGainDb),this.setVocalParams(s.vocal)},setWorkletParams(s){i.port.postMessage({type:"SET_PARAMS",params:s})},setEqParams(s,K){O(l,p,u,m,s,K)},setMasterGain(s){_=x(s),c.gain.setTargetAtTime(_,a.currentTime,.05)},setVocalParams(s){o.port.postMessage({type:"SET_PARAMS",params:s})},onMetering(s){G=s}}}function O(e,t,a,n,o,i){e.frequency.value=o.highPassHz>0?o.highPassHz:1,e.Q.value=.707,t.frequency.value=o.lowShelfHz,t.gain.value=i?o.lowShelfGainDb:0,a.frequency.value=o.peakingHz,a.gain.value=i?o.peakingGainDb:0,a.Q.value=o.peakingQ,n.frequency.value=o.highShelfHz,n.gain.value=i?o.highShelfGainDb:0}var I={enabled:!1,presetId:L,masterGainDb:-6,eqEnabled:!0,vocalEnhance:!0};async function U(){return await chrome.storage.sync.get(I)}function z(e){chrome.storage.onChanged.addListener((t,a)=>{if(a!=="sync")return;let n={};for(let o of Object.keys(t))o in I&&(n[o]=t[o].newValue);Object.keys(n).length>0&&e(n)})}function B(e){if(!e||typeof e!="object")return!1;let t=e;return t.type==="SET_ENABLED"||t.type==="SET_PRESET"||t.type==="SET_MASTER_GAIN"||t.type==="SET_EQ_ENABLED"||t.type==="SET_VOCAL_ENHANCE"||t.type==="GET_STATUS"}var r=null,b=L,g=0,P=!0,f=!1,R=!1,N=1,S=!1,h=null,Q=new WeakSet,d=null;function q(){return{enabled:f,presetId:b,masterGainDb:g,pipelineReady:R,audioContextState:r?r.ctx.state:"closed",vocalEnhance:S}}function w(e){chrome.runtime.sendMessage(e).catch(()=>{})}function C(){h&&(f?(h.playbackRate=N,h.preservesPitch=!1):(h.playbackRate=1,h.preservesPitch=!0))}async function te(e){if(Q.has(e))return;r&&(r.destroy(),r=null,R=!1);let t=E(b);if(t)try{let a={...t.params,masterGainDb:g,eqEnabled:P,vocal:{separator:{enabled:S,vocalGainDb:t.params.vocal.separator.vocalGainDb,musicReductionDb:t.params.vocal.separator.musicReductionDb}}};r=await W(e,a),h=e,Q.add(e),R=!0,console.log("[Sleep Mode] Pipeline created",{audioContextState:r.ctx.state,sampleRate:r.ctx.sampleRate,videoSrc:e.src?.substring(0,80),videoCrossOrigin:e.crossOrigin,videoReadyState:e.readyState,videoPaused:e.paused}),C(),d&&(document.removeEventListener("click",d),document.removeEventListener("keydown",d),d=null),r.ctx.state==="suspended"&&(d=()=>{r?.ctx.resume(),d&&(document.removeEventListener("click",d),document.removeEventListener("keydown",d),d=null)},document.addEventListener("click",d),document.addEventListener("keydown",d)),f||r.bypass();let n=0;r.onMetering(o=>{f&&(w({type:"METERING",data:o}),n<5&&(n++,console.log("[Sleep Mode] Metering",{inputPeakDb:o.inputPeakDb.toFixed(1),lufs:o.currentLufs.toFixed(1),gainReduction:o.gainReductionDb.toFixed(1)})))}),w({type:"STATUS",data:q()})}catch(a){console.error("[Sleep Mode] Pipeline init failed:",a),R=!1}}function j(e){let t=E(e);!t||!r||(b=e,N=t.playbackRate,g=t.params.masterGainDb,P=t.params.eqEnabled,S=t.params.vocal.separator.enabled,r.setPreset(t.params),C())}function Y(e){f=e,r&&(f?(r.engage(),r.ctx.resume()):r.bypass(),C(),w({type:"STATUS",data:q()}))}function $(e){S=e;let t=E(b);r?.setVocalParams({separator:{enabled:e,vocalGainDb:t?.params.vocal.separator.vocalGainDb??0,musicReductionDb:t?.params.vocal.separator.musicReductionDb??-12}})}chrome.runtime.onMessage.addListener((e,t,a)=>{if(B(e))switch(e.type){case"SET_ENABLED":Y(e.enabled);break;case"SET_PRESET":j(e.presetId);break;case"SET_MASTER_GAIN":g=e.gainDb,r?.setMasterGain(e.gainDb);break;case"SET_EQ_ENABLED":P=e.enabled,r?.setEqParams(E(b)?.params.eq??A,e.enabled);break;case"SET_VOCAL_ENHANCE":$(e.enabled);break;case"GET_STATUS":return a({type:"STATUS",data:q()}),!0}});z(e=>{e.enabled!==void 0&&Y(e.enabled),e.presetId!==void 0&&j(e.presetId),e.masterGainDb!==void 0&&(g=e.masterGainDb,r?.setMasterGain(e.masterGainDb)),e.eqEnabled!==void 0&&(P=e.eqEnabled,r?.setEqParams(E(b)?.params.eq??A,e.eqEnabled)),e.vocalEnhance!==void 0&&$(e.vocalEnhance)});var ae=new v({onVideoFound(e){te(e)},onNavigate(){w({type:"STATUS",data:q()})}});async function oe(){let e=await U();f=e.enabled,b=e.presetId,g=e.masterGainDb,P=e.eqEnabled,S=e.vocalEnhance;let t=E(b);t&&(N=t.playbackRate),ae.start()}oe();})();
