# Sleep Mode for YouTube

一款 Chrome 扩展，将任何 YouTube 视频的音频实时转化为适合睡眠的声音。

## 问题

数百万人每天听着 YouTube 入睡 -- 播客、有声书、ASMR、雨声。但 YouTube 的音频是为「吸引注意力」优化的，不是为「入睡」优化的：

- 背景音乐盖过说话的人
- 视频之间、甚至同一个视频内，音量忽大忽小
- 突然的笑声、掌声、咳嗽、音效把你惊醒
- 语速太快，昏昏欲睡的大脑跟不上
- 高频尖锐的声音在夜里听着刺耳

## 调研：这些是真实存在的问题

我们系统性地分析了 **100 个真实用户痛点案例**，来源覆盖 Reddit（r/sleep、r/podcasts、r/asmr）、Hacker News、YouTube 评论区、睡眠 App 评价和各类论坛讨论。每个案例从 9 个维度评分：严重程度、痛点分类、技术可解决性、方案匹配度、睡眠相关性、影响范围、内容类型、用户情绪、发生频率。

完整分析的交互式可视化页面：[`docs/research/用户痛点分析可视化.html`](docs/research/用户痛点分析可视化.html)。完整数据集和方法论：[`docs/research/`](docs/research/)。

### 数据发现

| 发现 | 数据 |
|------|------|
| 音量问题（最大痛点类别） | 占全部案例的 **31%** |
| 音频质量问题（第二大类别） | 占全部案例的 **22%** |
| 与我们产品完美或高度匹配的案例 | **36%**（36 个案例） |
| 我们能不同程度解决的案例 | **53%**（53 个案例） |
| 与睡眠场景直接或高度相关的案例 | **51%**（51 个案例） |
| 属于普遍或常见问题的案例 | **79%**（79 个案例） |
| P0 最高严重程度（直接导致惊醒） | **17%**（17 个案例） |
| P0+P1 严重+高严重程度 | **48%**（48 个案例） |

### 我们解决的痛点与功能对照

| 用户痛点 | 案例数 | 严重程度 | 我们的解决方案 | 对应功能 |
|---------|-------|---------|-------------|---------|
| 广告音量爆炸 / 视频间音量跳变 | 15 | P0-P1 | LUFS 标准化器将所有内容拉到一致的目标响度 | 标准化器 (-26 LUFS) |
| 同一视频内音量忽大忽小 | 13 | P1 | 快速 RMS 压缩器实时平滑响度变化 | 压缩器 (6:1, 100ms) |
| 突发的响亮声音（笑声、掌声、音效） | 6 | P0 | 前瞻限制器 + 真峰值限制器在 <5ms 内捕获瞬态 | 限制器 (-3dBFS) + 真峰值 (-2dBTP) |
| 背景音乐盖过说话者 | 7 | P1 | STFT 人声分离器削减音乐同时保留人声 | 人声增强 (音乐 -6dB) |
| 高频/齿音刺耳 | 4 | P2 | 高频搁架 EQ 衰减上频段 | Sleep EQ (6kHz, -4dB) |
| 语速太快，昏沉脑子跟不上 | 2 | P2 | 原生播放速率降低，音调自然下降 | 0.94x 速度 |

### 真实用户的声音

> *"安静的暴风雨视频后面突然跟了一个超级响的麦片广告，你多半会被突然吵醒"* -- Reddit 用户

> *"突然的音量变化，或者我根本没打算看的视频发出意想不到的声音，会在半夜把我从睡梦中惊醒"* -- Hacker News 用户

> *"背景音乐居然有歌词，我发现自己在努力听歌词而不是听主讲人在说什么"* -- 论坛用户

> *"主播为了强调会大幅改变音量，导致整体音量在安静和偶尔的大喊之间来回跳"* -- 播客听众

澳大利亚睡眠冥想频道创作者 Jason Stephenson（321 万订阅）发起请愿，收集了 **10,000+ 签名**抗议 YouTube 广告音量干扰睡眠内容。

### 我们解决不了什么

不是所有问题都是音频信号处理问题。**45% 的案例**超出了我们的能力范围：

| 问题类型 | 案例数 | 为什么解决不了 |
|---------|-------|-------------|
| 平台功能（自动播放、UI） | 16 | 需要 YouTube 自己修改 |
| 广告内容本身 | 11 | 需要 YouTube Premium 或广告屏蔽扩展 |
| 内容质量（TTS 合成语音、风格） | 6 | 内容创作问题 |
| 技术问题（蓝牙、缓冲） | 6 | 系统级问题 |

我们对边界保持透明。Sleep Mode 解决的是音频信号问题 -- 属于实时 DSP 领域的那 53%。

## Sleep Mode 做了什么

一键开启。扩展通过广播级信号链实时处理 YouTube 音频，让一切变得更安静、更平滑、更一致。每个处理环节都围绕一个原则设计：**声音只会变得更安静、更柔和，绝不会变得更响、更刺耳。**

## 安装

### 从源码构建

```bash
git clone https://github.com/Yida-Dev/sleep-mode-youtube.git
cd sleep-mode-youtube
npm install
npm run build
```

然后加载到 Chrome：

1. 打开 `chrome://extensions/`
2. 开启右上角「开发者模式」
3. 点击「加载已解压的扩展程序」
4. 选择 `dist/` 文件夹

### 快速加载（预构建）

仓库中包含 `dist/` 文件夹，可以直接加载到 Chrome，无需构建。

## 使用方法

1. 打开任意 YouTube 视频
2. 点击工具栏中的 Sleep Mode 扩展图标
3. 点击月亮按钮激活
4. 选择匹配你内容类型的预设
5. 完成 -- 一切自动调整

Sleep Mode 激活后，弹窗会显示实时状态：绿色「PROCESSING」指示灯确认音频正在被处理。

## 预设模式

Sleep Mode 内置四种预设，每种都针对特定内容类型精心调校。选择预设后所有音频参数自动设定，不需要调任何旋钮。

### Sleep（睡眠）

**适用于：** 播客、有声书、冥想引导、以说话为主的视频

这是默认预设，也是处理最积极的预设。它的目标是创造一层温暖、稳定的声音毯，让你在入睡过程中不会被任何声音打扰。

具体做了什么：

- **播放速度降低 6%**（0.94 倍速）。语速变慢的同时音调自然下降，声音变得更舒缓、更低沉。这使用浏览器原生重采样实现 -- 没有任何音频伪影，只是自然地变得温暖。
- **音量标准化到 -26 LUFS。** 这比 YouTube 默认音量（约 -14 LUFS）明显安静。不同说话者、不同片段、不同视频之间的音量差异被自动拉平。
- **激进的瞬态压缩**（6:1 压缩比，15ms 起音时间）。突然出现的声音尖峰 -- 一声笑、一声咳嗽、一个音效、广告切换 -- 在几毫秒内被捕获并削减。这是核心的「防惊醒」功能。
- **温暖 EQ。** 6kHz 高频搁架滤波器衰减 4dB，软化齿音（"s" 音）、镲片声和其他刺耳的高频内容。80Hz 高通滤波器去除低频隆隆声。
- **人声分离开启。** 背景音乐被削减 6dB，人声原样通过，让语音在低音量下也能清晰可辨。
- **主输出 -6dB**（50% 音量）。额外的安全网，确保最终输出远低于满刻度。

什么时候选 Sleep：你在听人说话，想伴着声音入睡，不想被任何突发声音惊醒。

### ASMR

**适用于：** 耳语内容、敲击、抓挠、口腔音、耳对耳音频

ASMR 内容本身就是为助眠设计的，所以这个预设处理最轻。目标是标准化音量的同时不破坏 ASMR 赖以生效的微妙声音纹理。

具体做了什么：

- **不改变播放速度**（1.0 倍速）。ASMR 依赖精确的节奏和时间感，减速会破坏触发效果。
- **音量标准化到 -28 LUFS。** 四个预设中最安静的 -- 比 Sleep 还低 2dB。耳语内容保持耳语音量。
- **激进的瞬态压缩**（6:1 压缩比，-26dB 阈值）。即使在 ASMR 视频中，某些触发音也可能意外地响（敲击、揉纸声）。压缩器会控制住这些峰值。
- **全频谱 EQ。** 不设高通滤波器，不做任何频率削减。ASMR 依赖微妙的次低频振动和高频细节，激进的 EQ 会损失这些。一切原样通过。
- **人声分离关闭。** ASMR 没有需要分离的「背景音乐」。触发音本身就是内容。
- **更低的限制器阈值**（-6dB）。更积极地捕获残余峰值，因为 ASMR 听众往往处于最安静、最敏感的聆听状态。
- **主输出 -6dB。**

什么时候选 ASMR：你在听耳语或纹理类内容，想要一致的音量但不改变声音特性。

### Podcast（播客）

**适用于：** 脱口秀、访谈、讲座、新闻评论、多人对话内容

Podcast 模式为语音清晰度优化。它是四个预设中最响的 -- 适用于你还想跟上对话内容、同时享受音量保护的场景。

具体做了什么：

- **播放速度降低 6%**（0.94 倍速）。和 Sleep 一样，让昏昏欲睡时更容易跟上语速。轻微的音调下降增加温暖感。
- **音量标准化到 -24 LUFS。** 比 Sleep 和 ASMR 都响。在较低的物理音量下也能清晰听到内容。不同说话者和片段之间的音量被自动拉平。
- **温和压缩**（3:1 压缩比，-20dB 阈值，20ms 起音，宽 8dB 拐点）。不像 Sleep 那么激进 -- 保留更多对话的自然动态范围。仍然能捕获突发尖峰，但允许正常的语气强调通过。
- **人声前置 EQ。** 300Hz 低频搁架衰减 3dB，减少让语音变得浑浊的中低频，尤其在小扬声器或耳塞上效果明显。高频保持不变以保留语音清晰度。
- **人声分离开启 + 人声增强 3dB。** 背景音乐削减 6dB 的同时，人声被主动提升 3dB。这让说话者在混音中显著突出 -- 适合有音乐衬底、片头音乐或多人交叉对话的播客。
- **主输出 -3dB。** 比 Sleep/ASMR 略响，匹配「还醒着，还在听」的使用场景。
- **更高的真峰值天花板**（-1dBTP vs -2dBTP）。留出略多余量，因为播客听众对偶尔的接近峰值时刻不那么敏感。

什么时候选 Podcast：你想跟上对话内容，同时享受一致的音量和突发噪音保护。适合「躺在床上但还没打算睡着」的时刻。

### White Noise（白噪声）

**适用于：** 雨声、海浪、风扇声、环境音、自然录音、lo-fi 音乐

白噪声和环境音内容本身就很平滑。这个预设用最少的处理标准化音量，保留声音原本的、未经修改的特性。

具体做了什么：

- **不改变播放速度**（1.0 倍速）。环境音应该以自然速度播放。
- **音量标准化到 -26 LUFS。** 和 Sleep 相同的安静目标。确保不同环境音视频之间音量一致。
- **温和压缩**（3:1 压缩比，-22dB 阈值）。轻触式处理 -- 环境音很少有瞬态峰值，但某些自然录音会有偶尔的鸟叫、雷声或大浪。压缩器温和地平滑这些。
- **EQ 关闭。** 不做任何频率调整。雨声就应该听起来像雨声，不是像被滤波过的雨声。音频在频谱上完全不受干预地通过。
- **人声分离关闭。** 没有需要分离的人声。环境音本身就是内容。
- **较低的限制器阈值**（-6dB）。为偶尔的峰值提供额外安全保障。
- **主输出 -3dB。**

什么时候选 White Noise：你在播放环境音或自然声音，想要稳定的音量但不改变声音的任何色彩。

### 预设对比

| | Sleep | ASMR | Podcast | White Noise |
|---|---|---|---|---|
| 目标响度 | -26 LUFS | -28 LUFS | -24 LUFS | -26 LUFS |
| 播放速度 | 0.94x | 1.0x | 0.94x | 1.0x |
| 压缩 | 6:1 激进 | 6:1 激进 | 3:1 温和 | 3:1 温和 |
| EQ 特性 | 温暖（高频 -4dB） | 平坦（全频谱） | 人声前置（低频 -3dB） | 关闭 |
| 人声分离 | 开启（音乐 -6dB） | 关闭 | 开启（人声 +3dB，音乐 -6dB） | 关闭 |
| 主输出 | -6dB | -6dB | -3dB | -3dB |

**响度排名**（从最安静到最响）：ASMR (-28) < Sleep (-26) = White Noise (-26) < Podcast (-24)

## 控件

### Sleep EQ

开关控件，启用或禁用当前预设的 EQ 配置。开启时，上面各预设描述的频率调整生效。关闭时，不施加任何 EQ -- 音频保持原始频率平衡。

提示：如果觉得某个预设听起来太闷或太亮，试试关掉 Sleep EQ。标准化器和压缩器仍然正常工作。

### Vocal Enhance（人声增强）

开关控件，启用或禁用人声分离器。开启时，背景音乐被削减，人声（根据预设不同）可能被增强。关闭时，所有音频均等通过。

注意：Vocal Enhance 在有明确「人声 + 音乐」分层的内容上效果最好（带背景音乐的播客、有片头音乐的脱口秀）。对纯人声录音或环境音内容没有明显效果。

## 仪表

弹窗底部显示三个实时仪表，每秒更新约 10 次：

### LUFS

输入信号的当前测量响度，单位为 LUFS（响度单位满刻度），使用 EBU R128 / BS.1770 标准的 K 加权。标准化器根据这个值决定衰减多少。

- 典型 YouTube 内容读数在 **-10 到 -20 LUFS** 之间
- 标准化器的目标是预设的 LUFS 值（例如 Sleep 为 -26）
- 如果读数接近目标值，说明标准化正在正确工作

### Gain Reduction（增益衰减）

压缩器、限制器和真峰值限制器合计削减了多少信号，单位 dB。这告诉你动态处理正在多努力地工作。

- **0.0 dB**：没有压缩 -- 音频已经低于所有阈值
- **1-3 dB**：正常工作 -- 轻柔的压缩在平滑声音
- **3-6 dB**：中度压缩 -- 压缩器正在积极驯服较响的段落
- **6+ dB**：重度压缩 -- 一个响亮的瞬态被捕获并显著削减

### Input Peak（输入峰值）

进入处理器的原始音频峰值电平，单位 dBFS（相对满刻度分贝）。这是一个诊断值。

- **-inf dB**：没有音频信号到达处理器（检查视频是否正在播放）
- **-30 到 -10 dB**：大多数内容的正常工作范围
- **-6 dB 以上**：信号非常热 -- 压缩器和限制器将大力工作

## 技术细节

### 信号链

```
YouTube <video> 元素
    |
    MediaElementSourceNode
    |
    人声分离器 (AudioWorklet: STFT 中/侧, 2048 点 FFT)
    |
    高通滤波器 (BiquadFilterNode)
    |
    三段 EQ (BiquadFilterNode x3: 低频搁架、峰值、高频搁架)
    |
    Sleep 处理器 (AudioWorklet, 4 级):
      1. 标准化器  -- BS.1770 K 加权 LUFS, 3 秒窗口, 1dB/s 速率限制
      2. 压缩器    -- 快速 RMS (100ms), 软拐点, 按预设设定比率
      3. 限制器    -- 前瞻峰值限制, 5ms 延迟, 1ms 起音
      4. 真峰值    -- 4x 线性插值, -2dBTP 天花板
    |
    主增益 (GainNode)
    |
    AudioContext.destination
```

### 关键设计决策

- **不使用 DynamicsCompressorNode**：Web Audio 内置压缩器有无法禁用的自动补偿增益，会导致音量反而增大。我们使用自定义 Worklet 实现替代。
- **标准化器测量原始输入**：LUFS 测量在未处理信号上进行，增益单独施加。这防止了与下游环节的反馈回路。
- **条件性增益提升**：标准化器只在信号低于 -35 LUFS（真正安静的内容）时才会增益。正常和较响的内容只会被衰减，永远不会被放大。
- **原生变调**：不使用 DSP 变调算法（在 AudioWorklet 的 128 采样块中会产生伪影），而是通过 `video.playbackRate` 配合 `preservesPitch=false`，利用浏览器原生 C++ 重采样器实现无伪影的音调降低。

### 架构

- **Manifest V3** Chrome 扩展
- **Content Script**：管理 Web Audio 管线生命周期、YouTube DOM 观察
- **AudioWorklet**：所有自定义 DSP 在专用音频线程运行（48kHz 下每 128 采样块 2.67ms 时间预算）
- **Popup**：无状态控制面板。所有状态存储在 `chrome.storage.sync`
- **Service Worker**：纯消息路由，不处理音频

## 构建

```bash
npm run build    # 生产构建 (esbuild IIFE 包)
npx tsc --noEmit # 仅类型检查
```

## 许可证

MIT
