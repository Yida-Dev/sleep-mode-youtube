# YouTube Sleep Mode - 产品规划与技术方案

## 一、需求评估与优先级

### 1.1 需求文档原始需求

| 编号 | 痛点 | 技术可解决性 | 优先级 |
|------|------|-------------|--------|
| 1 | 有嘈杂的背景音乐 | 中（EQ可部分解决，完全分离需AI） | P1 |
| 2 | 音轨音量大小不一致 | **高**（动态压缩） | **P0** |
| 3 | 有突然的音效、笑声、咳嗽、掌声等 | **高**（限幅器） | **P0** |
| 4 | 说话语速过快 | 高（YouTube原生支持，我们增强） | P1 |
| 5 | 人声音调过高 | 中（EQ可柔化高频） | P2 |
| 6 | 其他 | 视具体问题 | P2 |

### 1.2 基于100个用户案例的分析

从100个痛点案例中，最高频的问题是：

| 问题类型 | 案例数 | 核心场景 |
|---------|-------|---------|
| 音量突变（广告、视频间、视频内） | ~35 | 睡着被惊醒 |
| 突发音效（笑声、雷声、intro音乐） | ~20 | 正在入睡时被吓到 |
| 背景音乐盖过人声 | ~15 | 听不清内容 |
| 语速太快 | ~5 | 无法放松 |

### 1.3 最终优先级决策

**MVP 必须解决（P0）：**
- 音量突变 → **动态范围压缩**
- 突发响声 → **硬限幅器**

**MVP 应该包含（P1）：**
- 高频刺耳 → **EQ柔化**
- 语速调节 → **播放速度控制**（YouTube原生+增强）

**后续迭代（P2）：**
- 背景音乐分离 → 需要AI处理，服务端方案

---

## 二、产品形态决策

### 2.1 方案对比

| 方案 | 用户体验 | 开发成本 | 服务器成本 | 跨平台 |
|------|---------|---------|-----------|--------|
| Web App（下载处理） | 差（等待） | 中 | 高 | 好 |
| **浏览器扩展** | **好（实时）** | **低** | **无** | 仅桌面 |
| 移动App | 好 | 高 | 中 | 好 |

### 2.2 最终决策：Chrome 浏览器扩展

**理由：**

1. **用户体验最佳**
   - 一键开启，实时生效
   - 无需等待下载和处理
   - 与YouTube原生体验无缝集成

2. **技术完全可行**
   - Web Audio API 原生支持所有所需功能
   - 已有成熟开源项目可参考（Equalizer Plus: 10,000+用户）
   - 性能优异，无延迟

3. **开发效率高**
   - 无需服务器
   - 1-2周可完成MVP
   - 可直接参考现有开源实现

4. **符合主要用户场景**
   - 根据调研，72%青少年、67%年轻人睡前用手机，但桌面用户同样重要
   - 桌面浏览器是可控性最强的环境

### 2.3 关于移动端

暂不支持移动端，原因：
- Chrome移动版不支持扩展
- 移动App开发成本高，审核复杂
- 先验证桌面端需求，再考虑移动端方案

---

## 三、技术架构

### 3.1 核心架构图

```
YouTube 页面
    │
    ▼
┌─────────────────────────────────────────────────┐
│  Content Script (content.js)                     │
│  ┌─────────────────────────────────────────┐    │
│  │         Web Audio API 处理链              │    │
│  │                                          │    │
│  │  video → Source → EQ → Compressor →     │    │
│  │                       Limiter → Gain →   │    │
│  │                              Destination │    │
│  └─────────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
         ▲                    │
         │                    ▼
┌────────┴────────┐    ┌─────────────┐
│  Popup UI       │◄──►│  Storage    │
│  (控制面板)      │    │  (设置存储)  │
└─────────────────┘    └─────────────┘
```

### 3.2 音频处理链详解

```
MediaElementSource (YouTube video元素)
         │
         ▼
    BiquadFilter (低频搁架, 200Hz, +3dB) ─── 增加温暖感
         │
         ▼
    BiquadFilter (高频搁架, 4kHz, -3dB) ─── 柔化刺耳高频
         │
         ▼
    BiquadFilter (齿音衰减, 6kHz, -2dB) ─── 减少S音刺耳
         │
         ▼
    DynamicsCompressor (压缩器)
    - threshold: -18dB
    - ratio: 8:1
    - knee: 15dB                    ─── 压缩动态范围
    - attack: 20ms
    - release: 200ms
         │
         ▼
    DynamicsCompressor (限幅器)
    - threshold: -3dB
    - ratio: 20:1
    - knee: 0                       ─── 硬限制峰值
    - attack: 3ms
    - release: 100ms
         │
         ▼
    GainNode (输出音量)              ─── 用户可调
         │
         ▼
    AudioDestination (扬声器)
```

### 3.3 处理参数预设

| 预设 | 压缩阈值 | 压缩比 | 限幅阈值 | 高频衰减 | 适用场景 |
|------|---------|-------|---------|---------|---------|
| 睡眠模式（默认） | -18dB | 8:1 | -3dB | -3dB | 所有内容 |
| ASMR模式 | -24dB | 4:1 | -6dB | -2dB | ASMR视频 |
| 播客模式 | -15dB | 6:1 | -3dB | 0dB | 播客/讲座 |
| 自然声音 | -20dB | 4:1 | -6dB | -1dB | 雨声/白噪音 |

---

## 四、功能规格

### 4.1 MVP 功能清单

| 功能 | 描述 | 实现方式 | 优先级 |
|------|------|---------|--------|
| **睡眠模式开关** | 一键启用/禁用所有处理 | Popup按钮 | P0 |
| **动态压缩** | 压缩音量范围，避免突变 | DynamicsCompressorNode | P0 |
| **硬限幅** | 限制最大音量，防止爆音 | DynamicsCompressorNode | P0 |
| **高频柔化** | 减少刺耳高频 | BiquadFilterNode | P0 |
| **音量调节** | 整体音量增减 | GainNode | P0 |
| **预设选择** | 睡眠/ASMR/播客/自然声音 | 参数切换 | P1 |
| **播放速度** | 0.5x-1.0x可调 | YouTube原生API | P1 |

### 4.2 UI 设计

**Popup 控制面板布局：**

```
┌──────────────────────────────────┐
│      YouTube Sleep Mode          │
│      ────────────────            │
│                                  │
│   ┌──────────────────────────┐   │
│   │   [ 睡眠模式: 开 ]       │   │
│   └──────────────────────────┘   │
│                                  │
│   预设:  [睡眠模式 ▼]            │
│                                  │
│   压缩强度                       │
│   轻 ━━━━━━━●━━━━ 强             │
│                                  │
│   输出音量                       │
│   静音 ━━━━━━━●━━━ 最大          │
│                                  │
│   播放速度: [0.9x ▼]             │
│                                  │
│   ────────────────               │
│   处理状态: 已启用               │
│   当前视频: [视频标题...]        │
│                                  │
└──────────────────────────────────┘
```

### 4.3 用户流程

```
1. 安装扩展
       │
       ▼
2. 打开 YouTube，播放视频
       │
       ▼
3. 点击扩展图标
       │
       ▼
4. 开启"睡眠模式"
       │
       ▼
5. （可选）调节预设/参数
       │
       ▼
6. 音频实时处理生效
       │
       ▼
7. 设置自动保存，下次打开自动应用
```

---

## 五、技术实现细节

### 5.1 项目结构

```
youtube-sleep-mode/
├── manifest.json           # 扩展配置
├── src/
│   ├── content/
│   │   ├── content.js      # 注入YouTube页面
│   │   └── processor.js    # 音频处理核心
│   ├── popup/
│   │   ├── popup.html      # 控制面板
│   │   ├── popup.js        # 控制逻辑
│   │   └── popup.css       # 样式
│   ├── background/
│   │   └── service-worker.js
│   └── utils/
│       └── storage.js      # 设置存储
├── icons/                  # 扩展图标
└── README.md               # 使用说明
```

### 5.2 关键代码逻辑

**1. 检测YouTube视频元素：**
```javascript
// 等待视频元素加载
function waitForVideo() {
    const video = document.querySelector('video');
    if (video) {
        initProcessor(video);
    } else {
        setTimeout(waitForVideo, 500);
    }
}
```

**2. 初始化音频处理链：**
```javascript
function initProcessor(video) {
    const ctx = new AudioContext();
    const source = ctx.createMediaElementSource(video);

    // 创建处理节点...
    // 连接处理链...
}
```

**3. 监听YouTube页面导航：**
```javascript
// YouTube是SPA，需要监听URL变化
const observer = new MutationObserver(() => {
    if (document.querySelector('video') && !processorInitialized) {
        initProcessor();
    }
});
```

### 5.3 兼容性处理

| 问题 | 解决方案 |
|------|---------|
| AudioContext需要用户手势 | 首次点击页面后初始化 |
| YouTube SPA导航 | MutationObserver监听DOM变化 |
| 视频切换 | 重新连接Source节点 |
| 设置持久化 | chrome.storage.sync |

---

## 六、测试用例验证

使用 requirement.txt 中的测试视频：

| 测试视频 | 预期问题 | 处理后效果 |
|---------|---------|-----------|
| https://www.youtube.com/watch?v=6_PI1l5NKL8 | 音量变化大 | 压缩后音量平稳 |
| https://www.youtube.com/watch?v=7ARBJQn6QkM | 可能有背景音 | 高频柔化后更舒适 |
| https://youtube.com/shorts/l7dIb1-Aymk | Shorts短视频 | 正常处理 |
| https://youtube.com/shorts/Th12tPRHX5s | Shorts短视频 | 正常处理 |

**验收标准：**
1. 处理后音量变化范围 < 15dB（原始可能 > 40dB）
2. 无突发尖峰超过 -3dB
3. 处理延迟 < 10ms（用户无感）
4. CPU占用 < 5%

---

## 七、开发计划

### 7.1 时间线

| 阶段 | 任务 | 时间 |
|------|------|------|
| Day 1 | 项目初始化，基础框架 | 0.5天 |
| Day 2-3 | 音频处理核心实现 | 1.5天 |
| Day 4 | Popup UI 开发 | 1天 |
| Day 5 | 测试与调优 | 1天 |
| Day 6 | 文档编写，打包发布 | 0.5天 |

### 7.2 风险与应对

| 风险 | 影响 | 应对 |
|------|------|------|
| YouTube页面结构变化 | video选择器失效 | 多选择器候选 |
| Chrome扩展政策变化 | 可能下架 | 遵循政策，提供独立安装 |
| 与其他扩展冲突 | 音频处理异常 | 检测已有AudioContext |

---

## 八、交付物清单

根据 requirement.txt 要求：

| 交付物 | 描述 | 状态 |
|--------|------|------|
| 产品文档 | 本文档（需求评估、产品形态、技术架构） | ✅ 完成 |
| 产品GitHub链接 | 可运行的Chrome扩展代码 | 待开发 |
| 使用说明 | README.md | 待编写 |

---

## 九、总结

### 9.1 产品定位

> **一句话**：Chrome扩展，一键让YouTube音频适合睡眠收听。

### 9.2 核心价值

| 用户痛点 | 解决方案 | 技术实现 |
|---------|---------|---------|
| 音量突变惊醒 | 动态压缩 | DynamicsCompressorNode |
| 突发响声吓人 | 硬限幅 | DynamicsCompressorNode |
| 高频刺耳 | 柔化EQ | BiquadFilterNode |
| 语速太快 | 速度调节 | YouTube playbackRate |

### 9.3 为什么选择浏览器扩展而非Web App

1. **实时处理 vs 预处理**：无需等待，即时生效
2. **零服务器成本**：纯客户端，无需后端
3. **无版权风险**：不下载不存储内容
4. **最佳用户体验**：与YouTube无缝集成
